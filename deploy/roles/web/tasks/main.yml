- name: create conf directory
  file:
    path: /opt/cloudland/web/conf
    state: directory
    owner: cland
    group: cland

- name: generate cland certs
  script: gencert.sh
  tags: [web_conf]

- name: cloudland base config file
  template:
    src: config.toml.j2
    dest: /opt/cloudland/web/conf/config.toml
  tags: [web_conf]

- name: copy service files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: preserve
  with_items:
    - {src: 'clbase.service', dest: '/lib/systemd/system', owner: 'root'}
    - {src: 'clbase.sh', dest: '/usr/local/bin', owner: 'cland'}
    - {src: 'clapi.service', dest: '/lib/systemd/system', owner: 'root'}
    - {src: 'clapi.sh', dest: '/usr/local/bin', owner: 'cland'}
  tags: [web_srv]

- name: start clbase services
  systemd: 
    name: clbase
    enabled: yes
    state: restarted
  tags: [web_srv]

- name: start clapi services
  systemd: 
    name: clapi
    enabled: yes
    state: restarted
  tags: [web_srv]

- name: generate console proxy certs
  script: console_cert.sh
  tags: [console]

- name: generate console proxy service
  template:
    src: consoleproxy.service.j2
    dest: /lib/systemd/system/consoleproxy.service
  tags: [console]
  
- name: start virt console proxy
  systemd: 
    name: consoleproxy
    enabled: yes
    daemon_reload: yes
    state: restarted
  tags: [fe_srv,console]
